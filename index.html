<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Troubleshooting Steps Ordering Game</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111c33;
      --panel-soft: #17233e;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --focus: #fbbf24;
      --ok: #22c55e;
      --bad: #ef4444;
      --card: #1d2c4a;
      --card-hover: #24385f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0%, var(--bg) 45%);
      color: var(--text);
      min-height: 100vh;
      padding: 1rem;
    }

    .game {
      max-width: 1100px;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 14px;
      padding: 1rem;
      position: relative;
      overflow: hidden;
    }

    h1 {
      margin: 0 0 0.5rem;
      font-size: clamp(1.3rem, 2.6vw, 2rem);
    }

    .subtitle {
      margin: 0 0 1rem;
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .panel {
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      background: var(--panel);
      padding: 0.85rem;
    }

    .panel h2 {
      margin: 0 0 0.25rem;
      font-size: 1.05rem;
    }

    .hint {
      margin: 0 0 0.75rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .slots {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .slot,
    .choices {
      border: 2px dashed rgba(148, 163, 184, 0.45);
      border-radius: 10px;
      background: var(--panel-soft);
    }

    .slot {
      display: flex;
      align-items: stretch;
      gap: 0.6rem;
      min-height: 48px;
      padding: 0.45rem;
      transition: border-color 0.15s ease;
    }

    .slot-label {
      width: 2rem;
      min-width: 2rem;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.2);
      color: #cbd5e1;
      display: grid;
      place-items: center;
      font-weight: 700;
    }

    .slot-content {
      flex: 1;
      min-height: 48px;
      display: flex;
      align-items: center;
    }

    .slot.keyboard-target,
    .choices.keyboard-target {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.25);
    }

    .slot.correct {
      border-style: solid;
      border-color: var(--ok);
    }

    .slot.incorrect {
      border-style: solid;
      border-color: var(--bad);
    }

    .mark {
      align-self: center;
      min-width: 2rem;
      font-weight: 800;
      text-align: center;
    }

    .choices {
      min-height: 300px;
      padding: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
    }

    .card {
      width: 100%;
      border: 1px solid rgba(191, 219, 254, 0.35);
      border-radius: 10px;
      background: linear-gradient(180deg, var(--card), #1b2a45);
      color: #f8fafc;
      text-align: left;
      font-size: 0.96rem;
      padding: 0.7rem;
      min-height: 48px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.1s ease, border-color 0.2s ease, background 0.2s ease;
    }

    .card:hover { background: var(--card-hover); }

    .card.selected {
      border-color: var(--focus);
      box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
      transform: translateY(-1px);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 0.7rem 1rem;
      font-weight: 700;
      cursor: pointer;
    }

    .primary { background: #93c5fd; color: #0f172a; }
    .secondary { background: #cbd5e1; color: #0f172a; }

    .message {
      margin-top: 0.65rem;
      min-height: 1.4rem;
      font-weight: 600;
    }

    .instructions {
      margin-top: 1rem;
      color: #cbd5e1;
      font-size: 0.93rem;
      line-height: 1.4;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    :focus-visible {
      outline: 3px solid rgba(251, 191, 36, 0.95);
      outline-offset: 2px;
    }

    canvas#confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: none;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .slots-panel { order: 1; }
      .choices-panel { order: 2; }
    }
  </style>
</head>
<body>
  <main class="game" aria-describedby="game-instructions">
    <canvas id="confetti" aria-hidden="true"></canvas>

    <h1>Troubleshooting Steps — Put Them in Order</h1>
    <p class="subtitle">Tap a card to pick it up, then tap a slot to place it. Tap Choices to return a selected card.</p>

    <section class="layout">
      <div class="panel slots-panel">
        <h2>Slots</h2>
        <p class="hint">Start at step 1 and end at step 6.</p>
        <div id="slots" class="slots" aria-label="Step slots"></div>
      </div>

      <div class="panel choices-panel">
        <h2>Choices</h2>
        <p class="hint">All cards start here and can always be moved back.</p>
        <div id="choices" class="choices" tabindex="0" role="list" aria-label="Choices area"></div>
      </div>
    </section>

    <div class="controls">
      <button id="checkBtn" class="primary" type="button">Check Answers</button>
      <button id="resetBtn" class="secondary" type="button">Reset</button>
    </div>

    <p id="message" class="message" aria-live="polite"></p>
    <p id="game-instructions" class="instructions">
      Keyboard: Tab to a card then Enter/Space to pick up. Arrow Up/Down chooses slot target. Press C to target Choices. Enter/Space drops, Esc cancels, Backspace/Delete returns a placed card to Choices.
    </p>
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true"></div>
  </main>

  <script>
    (() => {
      const steps = [
        { id: 'step1', text: 'Identify the problem.' },
        { id: 'step2', text: 'Establish a theory of the most likely cause (start with the obvious).' },
        { id: 'step3', text: 'Test the theory to determine the cause.' },
        { id: 'step4', text: 'Establish a plan to fix the problem and carry out the solution.' },
        { id: 'step5', text: 'Verify full system functionality and, if appropriate, implement preventive measures.' },
        { id: 'step6', text: 'Document findings, actions taken, and outcomes.' }
      ];

      const stepMap = new Map(steps.map(s => [s.id, s]));
      const slotsEl = document.getElementById('slots');
      const choicesEl = document.getElementById('choices');
      const checkBtn = document.getElementById('checkBtn');
      const resetBtn = document.getElementById('resetBtn');
      const messageEl = document.getElementById('message');
      const liveEl = document.getElementById('live');
      const confettiCanvas = document.getElementById('confetti');

      let choices = [];
      let slots = new Array(6).fill(null);
      let selectedCardId = null;
      let keyboardTarget = { type: 'slot', index: 0 };
      let hasSubmitted = false;
      let confettiRaf = null;
      let particles = [];

      function announce(text) {
        liveEl.textContent = '';
        requestAnimationFrame(() => { liveEl.textContent = text; });
      }

      function shuffle(arr) {
        const copy = [...arr];
        for (let i = copy.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
      }

      function locateCard(cardId) {
        const slotIndex = slots.findIndex(id => id === cardId);
        if (slotIndex >= 0) return { type: 'slot', index: slotIndex };
        return { type: 'choices', index: choices.indexOf(cardId) };
      }

      function moveCardToSlot(cardId, slotIndex) {
        const from = locateCard(cardId);
        if (from.type === 'choices' && from.index >= 0) {
          choices.splice(from.index, 1);
        } else if (from.type === 'slot') {
          slots[from.index] = null;
        }

        const occupyingId = slots[slotIndex];
        if (occupyingId) {
          slots[slotIndex] = null;
          if (from.type === 'slot') {
            slots[from.index] = occupyingId;
          } else {
            choices.push(occupyingId);
          }
        }

        slots[slotIndex] = cardId;
      }

      function moveCardToChoices(cardId) {
        const from = locateCard(cardId);
        if (from.type === 'slot') {
          slots[from.index] = null;
        } else if (from.type === 'choices' && from.index >= 0) {
          return;
        }
        choices.push(cardId);
      }

      function clearFeedback() {
        for (let i = 0; i < 6; i++) {
          const slot = document.getElementById(`slot-${i}`);
          if (!slot) continue;
          slot.classList.remove('correct', 'incorrect');
          const mark = slot.querySelector('.mark');
          if (mark) mark.textContent = '';
        }
      }

      function cancelSelection() {
        if (!selectedCardId) return;
        selectedCardId = null;
        keyboardTarget = { type: 'slot', index: 0 };
        announce('Selection cancelled.');
      }

      function dropSelectedToTarget() {
        if (!selectedCardId) return;
        if (keyboardTarget.type === 'choices') {
          moveCardToChoices(selectedCardId);
          announce(`Returned ${stepMap.get(selectedCardId).text} to choices.`);
        } else {
          moveCardToSlot(selectedCardId, keyboardTarget.index);
          announce(`Placed ${stepMap.get(selectedCardId).text} in slot ${keyboardTarget.index + 1}.`);
        }
        selectedCardId = null;
        if (hasSubmitted) {
          hasSubmitted = false;
          clearFeedback();
          messageEl.textContent = 'Answers changed. Press Check Answers to regrade.';
        }
        render();
      }

      function handlePickToggle(cardId) {
        if (selectedCardId === cardId) {
          cancelSelection();
        } else {
          selectedCardId = cardId;
          const current = locateCard(cardId);
          keyboardTarget = current.type === 'slot' ? { type: 'slot', index: current.index } : { type: 'slot', index: 0 };
          announce(`Picked up ${stepMap.get(cardId).text}`);
        }
        render();
      }

      function updateTargetHighlight() {
        document.querySelectorAll('.keyboard-target').forEach(el => el.classList.remove('keyboard-target'));
        if (!selectedCardId) return;

        if (keyboardTarget.type === 'choices') {
          choicesEl.classList.add('keyboard-target');
        } else {
          const slot = document.getElementById(`slot-${keyboardTarget.index}`);
          if (slot) slot.classList.add('keyboard-target');
        }
      }

      function makeCard(cardId) {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'card';
        card.dataset.cardId = cardId;
        card.setAttribute('tabindex', '0');
        card.setAttribute('role', 'listitem');
        card.textContent = stepMap.get(cardId).text;

        if (selectedCardId === cardId) {
          card.classList.add('selected');
          card.setAttribute('aria-pressed', 'true');
        } else {
          card.setAttribute('aria-pressed', 'false');
        }

        card.addEventListener('pointerdown', (e) => {
          if (e.pointerType === 'touch' || e.pointerType === 'pen') {
            e.preventDefault();
          }
        });

        card.addEventListener('click', () => handlePickToggle(cardId));

        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handlePickToggle(cardId);
            return;
          }

          if (!selectedCardId) return;

          if (e.key === 'Escape') {
            e.preventDefault();
            cancelSelection();
            render();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            keyboardTarget = { type: 'slot', index: Math.max(0, keyboardTarget.type === 'slot' ? keyboardTarget.index - 1 : 5) };
            updateTargetHighlight();
            announce(`Target slot ${keyboardTarget.index + 1}.`);
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            keyboardTarget = { type: 'slot', index: Math.min(5, keyboardTarget.type === 'slot' ? keyboardTarget.index + 1 : 0) };
            updateTargetHighlight();
            announce(`Target slot ${keyboardTarget.index + 1}.`);
          } else if (e.key.toLowerCase() === 'c') {
            e.preventDefault();
            keyboardTarget = { type: 'choices' };
            updateTargetHighlight();
            announce('Target choices.');
          } else if (e.key === 'Backspace' || e.key === 'Delete') {
            e.preventDefault();
            moveCardToChoices(cardId);
            if (hasSubmitted) {
              hasSubmitted = false;
              clearFeedback();
              messageEl.textContent = 'Answers changed. Press Check Answers to regrade.';
            }
            selectedCardId = null;
            render();
            announce(`Returned ${stepMap.get(cardId).text} to choices.`);
          }
        });

        return card;
      }

      function makeSlot(index) {
        const slot = document.createElement('div');
        slot.id = `slot-${index}`;
        slot.className = 'slot';
        slot.tabIndex = 0;
        slot.setAttribute('aria-label', `Slot ${index + 1}`);

        const label = document.createElement('div');
        label.className = 'slot-label';
        label.textContent = String(index + 1);

        const content = document.createElement('div');
        content.className = 'slot-content';
        if (slots[index]) content.appendChild(makeCard(slots[index]));

        const mark = document.createElement('div');
        mark.className = 'mark';

        slot.append(label, content, mark);

        slot.addEventListener('pointerdown', (e) => {
          if (e.pointerType === 'touch' || e.pointerType === 'pen') e.preventDefault();
        });

        slot.addEventListener('click', () => {
          if (!selectedCardId) return;
          keyboardTarget = { type: 'slot', index };
          dropSelectedToTarget();
        });

        slot.addEventListener('keydown', (e) => {
          if (!selectedCardId) return;

          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            keyboardTarget = { type: 'slot', index };
            dropSelectedToTarget();
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            keyboardTarget = { type: 'slot', index: Math.max(0, index - 1) };
            updateTargetHighlight();
            announce(`Target slot ${keyboardTarget.index + 1}.`);
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            keyboardTarget = { type: 'slot', index: Math.min(5, index + 1) };
            updateTargetHighlight();
            announce(`Target slot ${keyboardTarget.index + 1}.`);
          } else if (e.key.toLowerCase() === 'c') {
            e.preventDefault();
            keyboardTarget = { type: 'choices' };
            updateTargetHighlight();
            announce('Target choices.');
          } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelSelection();
            render();
          }
        });

        return slot;
      }

      function gradeAnswers() {
        hasSubmitted = true;
        let correctCount = 0;

        for (let i = 0; i < 6; i++) {
          const slot = document.getElementById(`slot-${i}`);
          if (!slot) continue;

          slot.classList.remove('correct', 'incorrect');
          const mark = slot.querySelector('.mark');
          const expected = steps[i].id;
          const actual = slots[i];

          if (actual === expected) {
            correctCount++;
            slot.classList.add('correct');
            if (mark) mark.textContent = '✓';
          } else {
            slot.classList.add('incorrect');
            if (mark) mark.textContent = '✗';
          }
        }

        if (correctCount === 6) {
          messageEl.textContent = 'Excellent! All steps are in the correct order.';
          announce('All answers correct.');
          startConfetti();
        } else {
          messageEl.textContent = `${correctCount} of 6 correct. Adjust and submit again.`;
          announce(`${correctCount} of 6 correct.`);
          stopConfetti();
        }
      }

      function startConfetti() {
        const ctx = confettiCanvas.getContext('2d');
        const rect = confettiCanvas.parentElement.getBoundingClientRect();
        confettiCanvas.width = Math.floor(rect.width * window.devicePixelRatio);
        confettiCanvas.height = Math.floor(rect.height * window.devicePixelRatio);
        confettiCanvas.style.width = `${rect.width}px`;
        confettiCanvas.style.height = `${rect.height}px`;
        ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
        confettiCanvas.style.display = 'block';

        particles = Array.from({ length: 140 }, () => ({
          x: Math.random() * rect.width,
          y: -Math.random() * rect.height,
          r: 3 + Math.random() * 4,
          vy: 1.4 + Math.random() * 2.6,
          vx: -1 + Math.random() * 2,
          a: Math.random() * Math.PI * 2,
          va: -0.08 + Math.random() * 0.16,
          color: ['#22c55e', '#60a5fa', '#f59e0b', '#f43f5e', '#eab308'][Math.floor(Math.random() * 5)]
        }));

        let start = null;
        function frame(ts) {
          if (!start) start = ts;
          const elapsed = ts - start;

          ctx.clearRect(0, 0, rect.width, rect.height);
          for (const p of particles) {
            p.x += p.vx;
            p.y += p.vy;
            p.a += p.va;
            if (p.y > rect.height + 30) {
              p.y = -20;
              p.x = Math.random() * rect.width;
            }
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.a);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.r, -p.r * 0.5, p.r * 2, p.r);
            ctx.restore();
          }

          if (elapsed < 4500) {
            confettiRaf = requestAnimationFrame(frame);
          } else {
            stopConfetti();
          }
        }

        cancelAnimationFrame(confettiRaf);
        confettiRaf = requestAnimationFrame(frame);
      }

      function stopConfetti() {
        cancelAnimationFrame(confettiRaf);
        confettiRaf = null;
        confettiCanvas.style.display = 'none';
      }

      function render() {
        slotsEl.innerHTML = '';
        for (let i = 0; i < 6; i++) slotsEl.appendChild(makeSlot(i));

        choicesEl.innerHTML = '';
        choices.forEach(cardId => choicesEl.appendChild(makeCard(cardId)));

        updateTargetHighlight();

        if (!hasSubmitted) {
          clearFeedback();
        }
      }

      choicesEl.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'touch' || e.pointerType === 'pen') e.preventDefault();
      });

      choicesEl.addEventListener('click', () => {
        if (!selectedCardId) return;
        keyboardTarget = { type: 'choices' };
        dropSelectedToTarget();
      });

      choicesEl.addEventListener('keydown', (e) => {
        if (!selectedCardId) return;

        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          keyboardTarget = { type: 'choices' };
          dropSelectedToTarget();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          keyboardTarget = { type: 'slot', index: 5 };
          updateTargetHighlight();
          announce('Target slot 6.');
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          keyboardTarget = { type: 'slot', index: 0 };
          updateTargetHighlight();
          announce('Target slot 1.');
        } else if (e.key.toLowerCase() === 'c') {
          e.preventDefault();
          keyboardTarget = { type: 'choices' };
          updateTargetHighlight();
          announce('Target choices.');
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelSelection();
          render();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && selectedCardId) {
          e.preventDefault();
          cancelSelection();
          render();
        }
      });

      checkBtn.addEventListener('click', gradeAnswers);

      resetBtn.addEventListener('click', () => {
        hasSubmitted = false;
        selectedCardId = null;
        keyboardTarget = { type: 'slot', index: 0 };
        slots = new Array(6).fill(null);
        choices = shuffle(steps.map(s => s.id));
        messageEl.textContent = '';
        stopConfetti();
        render();
        announce('Reset complete. Choices reshuffled.');
      });

      window.addEventListener('resize', () => {
        if (hasSubmitted && slots.every((id, i) => id === steps[i].id)) {
          startConfetti();
        }
      });

      function init() {
        choices = shuffle(steps.map(s => s.id));
        render();
      }

      init();
    })();
  </script>
</body>
</html>
